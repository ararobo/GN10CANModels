name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# 【重要】テスト結果を書き込むための権限設定
permissions:
  contents: read
  checks: write       # dorny/test-reporter に必要
  pull-requests: write # PRコメント投稿に必要

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------------------------
  # 1. Standalone C++ Test
  # -----------------------------------------------------------
  standalone_test:
    name: Generic C++ (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest] 
        # macOSはdornyアクションのパス解釈で工夫が必要な場合があるため一旦除外、または別途対応

    steps:
      - uses: actions/checkout@v4

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-standalone
          variant: ${{ matrix.os == 'windows-latest' && 'sccache' || 'ccache' }}

      - name: Configure CMake
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then LAUNCHER="sccache"; else LAUNCHER="ccache"; fi
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_FOR_ROS2=OFF \
            -DBUILD_TESTS=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=$LAUNCHER \
            -DCMAKE_CXX_COMPILER_LAUNCHER=$LAUNCHER

      - name: Build
        run: cmake --build build --config Release

      - name: Test
        working-directory: build
        # 【変更点】 --output-junit で結果をXMLに出力
        run: ctest -C Release --output-on-failure --output-junit test-results.xml

      # 【追加】 テスト結果のレポート
      - name: Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure() # テストがコケても実行する
        with:
          name: Standalone Tests (${{ matrix.os }})
          path: build/test-results.xml
          reporter: java-junit
          fail-on-error: false # 失敗は上のステップで検知済みなのでここではエラーにしない

  # -----------------------------------------------------------
  # 2. ROS 2 Test
  # -----------------------------------------------------------
  ros2_test:
    name: ROS 2 Humble
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble
          use-ros2-testing: true

      - uses: ros-tooling/action-ros-ci@v0.3
        id: action_ros_ci_step
        with:
          package-name: gn10_can
          target-ros2-distro: humble
          colcon-defaults: |
            {
              "build": {
                "cmake-args": ["-DBUILD_FOR_ROS2=ON", "-Wall", "-Wextra"]
              }
            }

      # 【追加】 ROS 2 テスト結果のレポート
      # colcon test はデフォルトで build/**/test_results/**/*.xml に結果を出力します
      - name: ROS 2 Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ROS 2 Tests
          # colconが生成するXMLのパスを指定
          path: ros_ws/build/**/test_results/**/*.xml
          reporter: java-junit
          fail-on-error: false