# 設計提案の比較と特徴まとめ

本ドキュメントでは、GN10 CANライブラリの設計改善案（提案1〜5）を比較し、それぞれの特徴、メリット、デメリットを整理します。

## 比較表

| 提案 | 手法 | 結合度 | 実装難易度 | ユーザーコードのシンプルさ | メモリ効率 | 特徴 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **1. インターフェース分離** | 純粋仮想クラスを用いた抽象化 (DIP) | 低 (Interface依存) | 中 | 普通 | 良 | テスト容易性が高い、教科書的な設計 |
| **2. コールバック** | `std::function` による処理委譲 | 極低 (Runtime) | 高 (Lambda多用) | やや複雑 | やや低 (func overhead) | クラス間の依存を完全に排除可能 |
| **3. Port/Mediator** | 中間オブジェクトによる接続 | 中 (Port依存) | 高 | やや複雑 | 良 | 接続設定の柔軟性が高い、大規模向け |
| **4. 前方宣言 (採用推奨)** | `forward declaration` による循環参照回避 | 高 (Pointer相互参照) | 低 | **普通** | **最良** | **既存コードへの影響最小、標準的なC++手法** |
| **5. RAII & Modern** | コンストラクタ/デストラクタによる自動管理 | 高 (Manager依存) | 中 | **最高** | 良 | 登録忘れがない、APIが直感的 |

---

## 各提案の詳細

### 提案1: インターフェース分離 (Interface Segregation)
`ICANSender` / `ICANReceiver` というインターフェースを定義し、具象クラスではなくインターフェースに依存させます。
- **メリット**: 単体テスト時にモック作成が容易。依存関係がクリーン。
- **デメリット**: ファイル数が増える。小規模プロジェクトでは過剰設計になりがち。

### 提案2: コールバック疎結合 (std::function / Observer)
関数オブジェクト (`std::function`) を介して送受信を行います。デバイスはマネージャーの存在を知る必要がありません。
- **メリット**: 最も疎結合。コンポーネントの独立性が高い。
- **デメリット**: デバッグ時にスタックトレースが追いづらい。組み込み環境では `virtual` 呼び出し以上のオーバーヘッドやメモリ確保を気にする必要がある。

### 提案3: Port/Mediator パターン
デバイスとマネージャーの間に `CANPort` オブジェクトを挟みます。
- **メリット**: 通信設定（バッファサイズやフィルタ）をポート単位で管理できる。
- **デメリット**: 構造が複雑になり、初期化時の「配線」コードが冗長になる。

### 提案4: 前方宣言とシンプル構成 (Simple Forward Declaration)
C++の基本機能である前方宣言 (`class CANManager;`) を使い、ヘッダーファイルでの相互インクルードを回避します。
- **メリット**: 学習コストが低い。余計な抽象化レイヤーがないため、実行効率が良い(ポインタ経由の直接呼び出し)。STLコンテナへの依存を最小限に抑えられる。
- **デメリット**: 実装ファイル(.cpp)レベルでは相互依存が残る（密結合）。

### 提案5: RAIIによる自動登録 (Modern RAII)
デバイス生成時に自動的にバスへ登録し、破棄時に解除します。
- **メリット**: ユーザーが `register` を呼ぶ必要がなく、バグを防ぎやすい。コードが短くなる。
- **デメリット**: 副作用（コンストラクタでの外部操作）が隠蔽されるため、一部の厳格なコーディング規約では嫌われる場合がある。

## 結論と推奨

- **組み込み環境でのリソース制約とメンテナンス性** を重視する場合、**提案4 (前方宣言)** が最もバランスが良いです。過度な抽象化を避け、C++の標準的な手法で循環参照のみを技術的に解決しています。
- **ユーザー体験 (DX)** を最優先する場合、**提案5 (RAII)** のアプローチが魅力的です。

現在は **提案4** のブランチ (`feat/proposal-4-forward-decl`) 、および **提案5** のブランチ (`feat/proposal-5-raii`) が実装済みであり、要件に応じて選択可能です。
